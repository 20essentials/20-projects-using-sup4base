<aside class='chat'>
  <section class='top'></section>
  <form class='bottom am-form'>
    <input
      type='text'
      class='am-input'
      maxlength='200'
      placeholder='Write a message...'
      autocomplete='off'
    />
    <input type='submit' class='send-message' value='Send' />
  </form>
</aside>
<style is:global>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    height: 100vh;
    width: 100%;
    background-image: url('/assets/tangerine.avif');
    background-size: cover;
    display: flex;
    flex-wrap: wrap;
    place-content: center;
  }

  .chat {
    width: 26vmax;
    height: 30vmax;
    background-color: #e9e9e988;
    border-radius: 2vmax;
    display: flex;
    flex-direction: column;

    .top {
      height: 90%;
      background-color: #ffa500aa;
      min-height: 10vmax;
      overflow-y: auto;
      border-top-left-radius: inherit;
      border-top-right-radius: inherit;
      display: flex;
      flex-direction: column;

      &::-webkit-scrollbar {
        width: 0.7vmax;
      }
      &::-webkit-scrollbar-thumb {
        background-image: linear-gradient(to bottom, transparent 3%, #0005 5%);
      }

      &::-webkit-scrollbar-track {
        background: transparent;
      }

      .single-message {
        display: flex;
        width: 100%;
        border-bottom: 0.1vmax solid #0008;

        .ms-left {
          width: 15%;
          background-color: #e9e9e988;
          display: flex;
          flex-wrap: wrap;
          place-content: center;

          img {
            width: 2vmax;
            height: 2vmax;
            border-radius: 50%;
          }
        }

        .ms-right {
          width: 90%;
          padding: 0.8vmax;
          font-size: 1vmax;
          overflow-wrap: anywhere;
          background-color: springgreen;
          background-color: #fff8;
          display: flex;
          flex-direction: column;

          .time-stamp {
            width: 100%;
            height: 1vmax;
            text-align: right;
          }
        }
      }
    }

    .bottom {
      height: 10%;
      display: flex;

      input {
        font-size: 1vmax;
        border: none;
        outline: none;
        background-color: transparent;
        padding-inline: 0.9vmax;
      }

      .am-input {
        width: 80%;
        padding-left: 1.5vmax;
      }

      .send-message {
        width: 20%;
        background-color: rgb(232, 30, 30);
        border-bottom-right-radius: 2vmax;

        &:active {
          opacity: 0.8;
        }
      }
    }
  }
</style>

<script>
  import { supabase } from '@/lib/supabase';
  import { $, baseUrl } from '@/utils/functions';

  const $form = $<HTMLFormElement>('.am-form');
  const $input = $<HTMLInputElement>('.am-input');
  const $container = $<HTMLElement>('.top');

  interface MessagePayload {
    messageValue: string;
    userName: string;
    userAvatar: string;
    timestamp: string;
  }

  const channel = supabase.channel('chat-room', {
    config: { broadcast: { self: true } }
  });

  const appendMessage = ({
    messageValue,
    userName,
    userAvatar,
    timestamp
  }: MessagePayload): void => {
    const html = `
    <aside class="single-message">
      <article class="ms-left">
        <img src="${userAvatar}" alt="${userName}" />
      </article>
      <article class="ms-right">
        <p><strong>${userName}</strong>: ${messageValue}</p>
        <span class="time-stamp">${timestamp}</span>
      </article>
    </aside>`;
    $container.insertAdjacentHTML('beforeend', html);
    $container.scrollTop = $container.scrollHeight;
  };

  channel.on(
    'broadcast',
    { event: 'message' },
    (e: { payload: MessagePayload }) => appendMessage(e.payload)
  );

  channel.subscribe(async (status: string) => {
    if (status !== 'SUBSCRIBED') return;

    const randomName = `User ${Math.floor(Math.random() * 999)}`;
    const { data } = await supabase.auth.getUser();

    let full_name = randomName;
    let avatar_url = baseUrl('/assets/userDefault.png');

    const identities = data?.user?.identities ?? [];
    const provider = identities.find(i => i.provider === 'google');
    const idData = provider?.identity_data ?? identities[0]?.identity_data;

    if (idData) {
      full_name = idData.full_name ?? full_name;
      avatar_url = idData.avatar_url ?? avatar_url;
    }

    await channel.track({
      name: full_name,
      avatar_url,
      joinedAt: new Date().toISOString()
    });

    $form.addEventListener('submit', async e => {
      e.preventDefault();
      const text = $input.value.trim();
      if (!text) return;

      const timestamp = new Date().toLocaleTimeString('es-ES', {
        hour: '2-digit',
        minute: '2-digit'
      });

      const result = await channel.send({
        type: 'broadcast',
        event: 'message',
        payload: {
          messageValue: text,
          userName: full_name,
          userAvatar: avatar_url,
          timestamp
        }
      });

      if (result === 'ok') $input.value = '';
    });
  });
</script>
