<aside class='container-searchs'>
  <section class='top'></section>
  <form class='bottom am-form'>
    <input
      type='text'
      class='am-input'
      maxlength='200'
      placeholder='Write a Country...'
      autocomplete='off'
    />
    <input type='submit' class='send-search' value='Search' />
  </form>
</aside>

<style is:global>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    height: 100vh;
    width: 100%;
    background-image: url('/assets/project-18-bg.avif');
    background-size: cover;
    display: flex;
    flex-wrap: wrap;
    place-content: center;
  }

  .container-searchs {
    width: 26vmax;
    height: 30vmax;
    background-color: #e9e9e988;
    border-radius: 2vmax;
    display: flex;
    flex-direction: column;

    .top {
      height: 90%;
      background-color: #9900ff88;
      min-height: 10vmax;
      overflow-y: auto;
      border-top-left-radius: inherit;
      border-top-right-radius: inherit;
      display: flex;
      flex-direction: column;

      &::-webkit-scrollbar {
        width: 0.7vmax;
      }
      &::-webkit-scrollbar-thumb {
        background-image: linear-gradient(to bottom, transparent 3%, #0005 5%);
      }

      &::-webkit-scrollbar-track {
        background: transparent;
      }

      .search-row {
        width: 100%;
        border-bottom: 0.1vmax solid #0008;
        padding: 0.8vmax;
        font-size: 1vmax;
        overflow-wrap: anywhere;
        background-color: #fff8;
        display: flex;
        flex-direction: column;
      }
    }

    .bottom {
      height: 10%;
      display: flex;

      input {
        font-size: 1vmax;
        border: none;
        outline: none;
        background-color: transparent;
        padding-inline: 0.9vmax;
      }

      .am-input {
        width: 80%;
        padding-left: 1.5vmax;
      }

      .send-search {
        width: 20%;
        background-color: rgb(232, 30, 151);
        border-bottom-right-radius: 2vmax;

        &:active {
          opacity: 0.8;
        }
      }
    }
  }
</style>

<script>
  import { supabase } from '@/lib/supabase';
  import { $ } from '@/utils/functions';

  interface CountryResult {
    id: string;
    name: string;
  }

  const form = $<HTMLFormElement>('.am-form');
  const input = $<HTMLInputElement>('.am-input');
  const container = $<HTMLElement>('.top');

  function renderResults(data: CountryResult[] | null) {
    container.innerHTML = '';
    if (!data?.length) {
      container.innerHTML = `<div class="search-row">No results found.</div>`;
      return;
    }

    const fragment = document.createDocumentFragment();
    for (const { id, name } of data) {
      const div = document.createElement('div');
      div.className = 'search-row';
      div.innerHTML = `
      <strong>${name}</strong>
      <span>Code: ${id}</span>
    `;
      fragment.appendChild(div);
    }
    container.appendChild(fragment);
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const query = input.value.trim();
    if (!query) {
      container.innerHTML = `<div class="search-row">Please enter a search term.</div>`;
      return;
    }

    container.innerHTML = `<div class="search-row">Searching...</div>`;

    try {
      const { data, error } = await supabase.rpc(
        'search_country_by_name_prefix',
        { prefix: query }
      );

      if (error) throw error;
      renderResults(data);
    } catch (err) {
      const message =
        (err as { message?: string })?.message ?? 'Search failed unexpectedly.';
      container.innerHTML = `<div class="search-row">Error: ${message}</div>`;
    } finally {
      input.value = '';
    }
  });
</script>
